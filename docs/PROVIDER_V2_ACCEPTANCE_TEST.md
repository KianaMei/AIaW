# Provider V2 验收测试清单

基于 `AIAW_Provider_Alignment_Plan.md` 的验收标准，本清单用于端到端测试。

## 🎯 核心验收标准

### ✅ 标准1：扁平数据结构

**验收条件**：新建自定义供应商后，Dexie 中仅存扁平记录（无 subproviders、fallbackProvider 字段）

- [ ] 打开浏览器开发者工具 → Application → IndexedDB → aiaw-db → providers
- [ ] 创建一个新的自定义供应商
- [ ] 检查数据库记录：
  - [ ] 包含 `id`, `name`, `type`, `apiHost`, `apiKey`, `models`, `enabled`, `settings`, `avatar`, `isSystem`
  - [ ] **不包含** `subproviders` 字段
  - [ ] **不包含** `fallbackProvider` 字段
  - [ ] `models` 为 `string[]` 类型（而非对象数组）

**通过标准**：✅ 所有字段符合 ProviderV2 接口定义

---

### ✅ 标准2：表单字段与 ProviderV2 一一对应

**验收条件**：供应商创建/编辑表单字段与 ProviderV2 一一对应

**测试步骤**：
1. [ ] 进入设置 → 供应商列表 → 添加自定义供应商
2. [ ] 验证以下表单字段存在且可编辑：
   - [ ] 供应商名称（name）
   - [ ] 供应商类型（type）- 下拉选择
   - [ ] API 地址（apiHost）
   - [ ] API 密钥（apiKey）
   - [ ] 启用状态（enabled）- 开关
   - [ ] 图标/头像（avatar）- 可点击选择
   - [ ] 模型列表（models）- 可输入或拉取

3. [ ] 填写所有字段并保存
4. [ ] 刷新页面，重新进入编辑页面
5. [ ] 验证所有字段值已保存且可正确回显

**通过标准**：✅ 所有 ProviderV2 字段都有对应的UI控件且能正确保存/读取

---

### ✅ 标准3：二级模型选择器

**验收条件**：聊天页/选择弹窗中，模型选择为二级（供应商 → 模型）

**测试步骤**：

#### 3.1 对话页模型选择
1. [ ] 打开任意对话
2. [ ] 点击模型选择区域
3. [ ] 验证第一级：
   - [ ] 显示所有已启用的供应商
   - [ ] 显示供应商头像和名称
   - [ ] 禁用的供应商不显示

4. [ ] 选择一个供应商（如 OpenAI）
5. [ ] 验证第二级：
   - [ ] 仅显示该供应商的模型
   - [ ] 模型列表包含静态模型和动态拉取的模型
   - [ ] 未选择供应商时，模型选择器禁用并提示"请先选择供应商"

#### 3.2 联动逻辑
1. [ ] 选择供应商 A → 选择模型 M1
2. [ ] 切换到供应商 B
3. [ ] 验证：模型选择自动清空
4. [ ] 选择模型 M2
5. [ ] 验证：最终绑定值为 `providerId:modelId` 格式

#### 3.3 历史会话回填
1. [ ] 打开一个历史会话（之前使用过 `provider:model` 格式）
2. [ ] 验证：
   - [ ] 供应商选择器自动回填正确的供应商
   - [ ] 模型选择器自动回填正确的模型
   - [ ] 可以正常发送消息

**通过标准**：✅ 二级选择器工作正常，联动逻辑正确，历史兼容无误

---

### ✅ 标准4：系统供应商兼容

**验收条件**：系统供应商（如 OpenAI, Anthropic）与自定义供应商无缝混用

**测试步骤**：
1. [ ] 在供应商列表中，同时看到系统供应商和自定义供应商
2. [ ] 验证系统供应商：
   - [ ] 有 `isSystem: true` 标记
   - [ ] 可以禁用/启用
   - [ ] **不能**编辑类型
   - [ ] **不能**删除

3. [ ] 验证自定义供应商：
   - [ ] `isSystem: false` 或无此字段
   - [ ] 可以编辑所有字段
   - [ ] 可以删除

4. [ ] 在对话中使用系统供应商的模型
5. [ ] 切换到自定义供应商的模型
6. [ ] 验证两者都能正常工作

**通过标准**：✅ 系统供应商和自定义供应商共存且行为符合预期

---

## 🔧 功能测试

### A. 供应商 CRUD

#### A1. 创建供应商
- [ ] 点击"添加自定义供应商"
- [ ] 填写必填字段（name, type, apiHost, apiKey）
- [ ] 保存后，供应商出现在列表中
- [ ] 数据库中创建了对应记录

#### A2. 编辑供应商
- [ ] 修改供应商名称
- [ ] 等待 500ms（防抖）
- [ ] 刷新页面，验证修改已保存
- [ ] 修改其他字段（apiHost, apiKey）
- [ ] 验证保存成功

#### A3. 删除供应商
- [ ] 点击"删除供应商"
- [ ] 弹出确认对话框，显示供应商名称
- [ ] 点击确认
- [ ] 供应商从列表中移除
- [ ] 数据库中记录被删除

#### A4. 启用/禁用供应商
- [ ] 切换供应商的启用开关
- [ ] 禁用后，供应商在对话页的选择器中隐藏
- [ ] 启用后，供应商重新出现

**通过标准**：✅ 所有 CRUD 操作正常工作

---

### B. 模型列表管理

#### B1. 手动输入模型
- [ ] 在模型列表输入框中输入 `gpt-4`
- [ ] 按 Enter
- [ ] 模型添加到列表
- [ ] 保存后，数据库中 `models` 数组包含 `"gpt-4"`

#### B2. 动态拉取模型（成功场景）
- [ ] 配置有效的 API 凭据
- [ ] 点击"从服务商获取模型"按钮
- [ ] 验证：
   - [ ] 显示加载动画
   - [ ] 成功后显示绿色通知："成功从服务商获取 X 个模型"
   - [ ] 模型列表更新为拉取的模型

#### B3. 动态拉取模型（失败降级）
- [ ] 配置无效的 API 凭据（错误的 Key）
- [ ] 点击"从服务商获取模型"按钮
- [ ] 验证：
   - [ ] 显示橙色警告通知
   - [ ] 通知内容包含错误原因
   - [ ] 通知内容包含降级信息："使用 X 个静态模型作为备用"
   - [ ] 模型列表更新为静态模型

#### B4. 静态模型加载
- [ ] 对于没有配置 API 的供应商
- [ ] 点击"从服务商获取模型"按钮
- [ ] 验证：
   - [ ] 显示蓝色信息通知
   - [ ] 加载预置的静态模型

**通过标准**：✅ 模型管理的三种模式都能正常工作

---

### C. 供应商验证

#### C1. 验证成功
- [ ] 配置正确的 API 凭据
- [ ] 点击"验证供应商"按钮
- [ ] 验证：
   - [ ] 显示加载动画
   - [ ] 成功后显示绿色徽章"有效"
   - [ ] 显示成功通知

#### C2. 验证失败
- [ ] 配置错误的 API Host 或 Key
- [ ] 点击"验证供应商"按钮
- [ ] 验证：
   - [ ] 显示红色徽章"无效"
   - [ ] Hover 徽章显示错误详情
   - [ ] 显示错误通知，包含具体错误信息

#### C3. 特殊供应商处理
- [ ] 测试 Ollama（本地供应商）
   - [ ] 不需要 API Key
   - [ ] 验证只检查连接性

- [ ] 测试 Azure
   - [ ] 需要额外的 `resourceName` 和 `apiVersion`
   - [ ] 验证逻辑正确处理这些字段

**通过标准**：✅ 验证功能准确反馈配置状态

---

### D. 能力矩阵

#### D1. Array Content 支持
- [ ] 选择支持数组内容的供应商（openai, anthropic, google）
- [ ] 在对话页，验证可以上传多张图片
- [ ] 选择不支持的供应商（如某些 openai-compatible）
- [ ] 验证多图片上传功能被禁用或提示不支持

#### D2. Developer Role 支持
- [ ] 选择 Anthropic 供应商
- [ ] 验证助手设置中显示 "Developer Role" 选项
- [ ] 选择其他供应商
- [ ] 验证该选项隐藏

#### D3. Service Tier 支持
- [ ] 选择 OpenAI 供应商
- [ ] 验证可以选择 service_tier（scale tier）
- [ ] 选择其他供应商
- [ ] 验证该选项隐藏

#### D4. URL Context 支持
- [ ] 选择 Google/Gemini 供应商
- [ ] 验证可以使用原生网页搜索功能
- [ ] 选择其他供应商
- [ ] 验证该功能不可用

**通过标准**：✅ UI 根据能力矩阵正确显示/隐藏功能

---

### E. 错误处理与边界情况

#### E1. 网络错误
- [ ] 断开网络连接
- [ ] 尝试拉取模型
- [ ] 验证：降级到静态模型，显示网络错误提示

#### E2. 超时处理
- [ ] 配置一个响应极慢的 API endpoint
- [ ] 点击拉取模型
- [ ] 验证：12 秒后超时，显示超时错误

#### E3. 必填字段校验
- [ ] 尝试保存没有填写 name 的供应商
- [ ] 验证：显示验证错误提示
- [ ] 填写 name，保存成功

#### E4. 重复 ID 处理
- [ ] 尝试创建两个相同 ID 的供应商
- [ ] 验证：第二个创建失败或自动生成新 ID

**通过标准**：✅ 所有错误都有合理的提示和处理

---

### F. 国际化（i18n）

#### F1. 英文界面
- [ ] 切换语言到 English
- [ ] 验证所有文本正确显示英文
- [ ] 特别检查：
   - [ ] 供应商设置页所有标签
   - [ ] 验证按钮和通知消息
   - [ ] 模型拉取成功/失败的提示

#### F2. 简体中文界面
- [ ] 切换语言到简体中文
- [ ] 验证所有文本正确显示中文
- [ ] 检查通知消息中的参数插值（如 `{count}`, `{error}`）

#### F3. 繁体中文界面
- [ ] 切换语言到繁体中文
- [ ] 验证所有文本正确显示繁体中文

**通过标准**：✅ 三种语言的所有文本都已翻译且格式正确

---

## 🔄 迁移测试

### G1. V1 数据迁移

**前置条件**：有旧版本的数据（包含 subproviders）

- [ ] 准备测试数据：旧版 Provider 格式
- [ ] 启动应用
- [ ] 打开浏览器 Console，查看迁移日志
- [ ] 验证：
   - [ ] 嵌套的 subproviders 被展开为独立的 Provider
   - [ ] 每个 Provider 都是扁平的 V2 格式
   - [ ] fallbackProvider 字段被移除
   - [ ] 迁移统计日志正确

### G2. 历史会话兼容

- [ ] 打开一个旧版本创建的会话
- [ ] 会话中使用的是 `provider:model` 格式
- [ ] 验证：
   - [ ] 会话正常加载
   - [ ] 模型选择器正确回填供应商和模型
   - [ ] 可以继续对话
   - [ ] 新消息使用新的数据格式

**通过标准**：✅ 旧数据迁移成功，历史会话兼容

---

## 🎨 UI/UX 测试

### H1. 响应式设计
- [ ] 在不同屏幕尺寸下测试供应商设置页
- [ ] 验证表单布局在小屏幕上仍可用

### H2. 加载状态
- [ ] 所有异步操作都显示加载动画
- [ ] 验证拉取模型时的 Loading 图标
- [ ] 验证验证供应商时的 Loading 状态

### H3. 通知提示
- [ ] 所有操作都有适当的通知反馈
- [ ] 成功操作显示绿色通知
- [ ] 失败操作显示红色通知
- [ ] 警告信息显示橙色通知

**通过标准**：✅ UI 交互流畅，反馈清晰

---

## 📊 性能测试

### I1. 大量供应商
- [ ] 创建 20+ 个自定义供应商
- [ ] 验证列表渲染性能
- [ ] 验证选择器性能

### I2. 大量模型
- [ ] 添加 100+ 个模型到一个供应商
- [ ] 验证模型选择器性能
- [ ] 验证搜索/筛选性能

**通过标准**：✅ 即使数据量大，UI 仍流畅响应

---

## ✅ 最终验收

### 所有标准通过清单

- [ ] ✅ 标准1：扁平数据结构
- [ ] ✅ 标准2：表单字段对应
- [ ] ✅ 标准3：二级模型选择器
- [ ] ✅ 标准4：系统供应商兼容
- [ ] 🔧 功能A：供应商 CRUD
- [ ] 🔧 功能B：模型列表管理
- [ ] 🔧 功能C：供应商验证
- [ ] 🔧 功能D：能力矩阵
- [ ] 🔧 功能E：错误处理
- [ ] 🔧 功能F：国际化
- [ ] 🔄 迁移G：数据迁移与兼容
- [ ] 🎨 UI/UX H：界面体验
- [ ] 📊 性能I：性能测试

### 签名确认

- 测试执行人：_______________
- 测试日期：_______________
- 测试通过：[ ] 是  [ ] 否
- 遗留问题数量：_______________

---

## 📝 问题记录

| 编号 | 问题描述 | 严重程度 | 状态 | 备注 |
|------|---------|---------|------|------|
| 1    |         | P0/P1/P2/P3 | Open/Fixed |      |
| 2    |         |         |      |      |
| 3    |         |         |      |      |

**严重程度说明**：
- P0: 阻塞发布的严重问题
- P1: 核心功能异常
- P2: 次要功能问题
- P3: 优化建议

---

完成此清单后，Provider V2 重构即可发布！🚀
